
# Build

Please refer to [the local development README](./doc/002-local-dev.md) for build instructions.

## Crossbuilds

When you push to your repo fork then GitHub Actions will automatically crossbuild for several OSs and CPU architectures. You'll then be able to download the built artifacts from the GitHub UI. The easiest way to crossbuild the Linux executables locally is to build and run the crossbuild container. Please refer to [the crossbuild container README](./docker-images/cross-build/README.md) for those steps. For hints on crossbuilding for MacOS and Windows see [the main GitHub Actions workflow](../.github/workflows/main.yml) which defines the steps that are run when you push to GitHub.

## FIPS

If you have a `go.work` file in the main "ziti" project's parent directory, then mount it and any sibling directories declared in the `go.work` file to allow the build to find local dependencies.

This example assumes a `../go.work` file like this, where `./agent` is one example of a local override for a dependency declared in the `ziti` project's `go.mod`. Running `go build` in the same directory as Ziti's `go.mod` will automatically detect and use the Go workspace defined in the parent directory. The `go build` command can also use a `go.work` file in the same directory as Ziti's `go.mod`, but it's necessary to use a `go.work` file from the parent directory for this technique that involves mounting multiple paths in a builder container that provides a specific distribution of Go toolchain.

### Define a Go Workspace

```go
go 1.24.0

use (
	./ziti
	./agent
)
```

### Build with Microsoft Go

This demonstrates how to build Ziti with FIPS enabled using Microsoft Go. These steps are automated in GitHub Actions ([link to Dockerfile](./dist/docker-images/ziti-cli-fips/Dockerfile)), but you can use them to build locally. You may need to adjust the paths to your Go build and module caches, and the version of the Go toolchain used by this project may have changed. Both of the prescribed build tags are required to enable FIPS mode.

Build Tags

- `goexperiment.opensslcrypto` - equivalent to setting `GOEXPERIMENT=opensslcrypto`. This activates `golang-fips/openssl` bindings which are present in Microsoft's distribution of Go toolchain.
- `requirefips` - configures the program to exit with an error if the OpenSSL FIPS Provider could not be loaded.

```bash
docker run --rm \
--volume $(realpath ../go.work):/mnt/go.work \
--volume $(realpath ../agent):/mnt/agent \
--volume $(realpath ../ziti):/mnt/ziti \
--workdir /mnt/ziti \
--user $(id -u):$(id -g) \
--volume="${HOME}/go/pkg/mod:/go/pkg/mod" \
--volume="${HOME}/.cache/go-build:/.cache/go-build" \
--env=GOCACHE=/.cache/go-build \
--env=CGO_ENABLED=1 \
mcr.microsoft.com/oss/go/microsoft/golang:1.24.1-1-bookworm \
go build \
-buildvcs=false \
-ldflags "$(ziti-ci -q go-build-flags -n)" \
-tags 'goexperiment.opensslcrypto,requirefips' \
-trimpath \
-o ./release/amd64/linux/ ./...
```

### OpenSSL Configuration

You must configure OpenSSL to use the FIPS Provider and configure the system library path to include the instance of OpenSSL that you configured for FIPS mode. For example, on an x86_64 or arm64 system running Linux, if you installed OpenSSL 3.1.2 (CMVP certificate #4985) in `/usr/local`, you would need to configure the system with `ldconfig` or set `LD_LIBRARY_PATH`. This configuration is then used by the Ziti program to dynamically load the correct OpenSSL library files at runtime (`dlopen`).

```bash
export LD_LIBRARY_PATH=/usr/local/lib64:/usr/local/lib
```

This is the expected list of providers when OpenSSL is configured for FIPS mode.

```bash
/usr/local/bin/openssl list -providers
Providers:
  base
    name: OpenSSL Base Provider
    version: 3.1.2
    status: active
  fips
    name: OpenSSL FIPS Provider
    version: 3.1.2
    status: active
```

Here's a snippet from the OpenSSL TOML highlighting the important directives for FIPS mode.

```toml
config_diagnostics = 1

[openssl_init]
providers = provider_sect
alg_section = algorithm_sect

[provider_sect]
fips = fips_sect
base = base_sect

[base_sect]
activate = 1

[algorithm_sect]
default_properties = fips=yes

# "[fips_sect]" section generated by OpenSSL, e.g., /usr/local/bin/openssl fipsinstall -out /usr/local/ssl/fipsmodule.cnf -module "/usr/local/lib64/ossl-modules/fips.so"
.include /usr/local/ssl/fipsmodule.cnf
```

### Confirm FIPS Mode

You can confirm that FIPS mode is enabled by running the following command. The program will exit with an error if it was built with tag `requirefips` but the OpenSSL FIPS Provider is not loaded in the OpenSSL context.

```bash
./release/amd64/linux/ziti version --verbose
Version:      v1.6.4
Revision:     0e4419763b91
Build Date:   2025-06-18T20:29:01-04:00
Go Version:   go1.24.1
OS/Arch:      linux/amd64
FIPS mode:    true
```